openapi: 3.0.3
info:
  title: CryptoExchange Registration & Setup API
  description: API endpoints for user registration, email validation, and MFA security method configuration
  version: 1.0.0
  contact:
    name: CryptoExchange API Support
    url: https://app.cryptoexchange.com

servers:
  - url: https://api.cryptoexchange.com
    description: Production server

paths:
  /api/v1/auth/register:
    post:
      summary: Register New User
      description: Create a new user account with email and password
      tags:
        - User Registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - alias
                - client_info
              properties:
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                password:
                  type: string
                  minLength: 8
                  example: "SecurePassword123!"
                alias:
                  type: string
                  example: "johndoe"
                client_info:
                  $ref: '#/components/schemas/ClientInfo'
      responses:
        '200':
          description: User registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Validation error or user already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/verify-email:
    post:
      summary: Verify Email Token
      description: Verify user email address using validation token
      tags:
        - Email Validation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - user_id
              properties:
                token:
                  type: string
                  format: uuid
                  example: "550e8400-e29b-41d4-a716-446655440006"
                user_id:
                  type: string
                  format: uuid
                  example: "550e8400-e29b-41d4-a716-446655440005"
      responses:
        '200':
          description: Email verification successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmailVerificationResponse'
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/resend-validation:
    post:
      summary: Resend Email Validation
      description: Resend email validation token to user
      tags:
        - Email Validation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: "john@example.com"
      responses:
        '200':
          description: Validation email resent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResendValidationResponse'
        '400':
          description: Rate limit exceeded or invalid email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/oauth/providers:
    get:
      summary: Get Supported OAuth Providers
      description: Retrieve list of supported OAuth authentication providers
      tags:
        - OAuth Providers
      responses:
        '200':
          description: OAuth providers retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthProvidersResponse'

  /api/v1/auth/mfa/webauthn/setup:
    post:
      summary: Initiate FIDO2 Setup
      description: Start FIDO2/WebAuthn hardware key setup process
      tags:
        - MFA Setup
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - device_name
              properties:
                device_name:
                  type: string
                  example: "YubiKey 5 NFC"
      responses:
        '200':
          description: FIDO2 setup initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnSetupResponse'
        '401':
          description: Unauthorized - invalid access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/mfa/webauthn/setup/complete:
    post:
      summary: Complete FIDO2 Setup
      description: Complete FIDO2/WebAuthn hardware key setup with credential
      tags:
        - MFA Setup
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - challenge_id
                - credential
                - device_name
              properties:
                challenge_id:
                  type: string
                  format: uuid
                  example: "550e8400-e29b-41d4-a716-446655440015"
                credential:
                  $ref: '#/components/schemas/WebAuthnSetupCredential'
                device_name:
                  type: string
                  example: "YubiKey 5 NFC"
      responses:
        '200':
          description: FIDO2 setup completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MFASetupCompleteResponse'
        '400':
          description: Setup expired or verification failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/mfa/biometric/setup:
    post:
      summary: Initiate Biometric Setup
      description: Start biometric authentication setup process
      tags:
        - MFA Setup
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - biometric_type
                - device_info
              properties:
                biometric_type:
                  type: string
                  enum: [fingerprint, face, voice]
                  example: "fingerprint"
                device_info:
                  type: object
                  required:
                    - platform
                    - device_model
                  properties:
                    platform:
                      type: string
                      enum: [android, ios, windows, macos]
                      example: "android"
                    device_model:
                      type: string
                      example: "Samsung Galaxy S21"
      responses:
        '200':
          description: Biometric setup initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BiometricSetupResponse'
        '401':
          description: Unauthorized - invalid access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/mfa/biometric/setup/complete:
    post:
      summary: Complete Biometric Setup
      description: Complete biometric authentication setup with credential
      tags:
        - MFA Setup
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - challenge_id
                - credential
                - biometric_type
              properties:
                challenge_id:
                  type: string
                  format: uuid
                  example: "550e8400-e29b-41d4-a716-446655440017"
                credential:
                  $ref: '#/components/schemas/WebAuthnSetupCredential'
                biometric_type:
                  type: string
                  enum: [fingerprint, face, voice]
                  example: "fingerprint"
      responses:
        '200':
          description: Biometric setup completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BiometricSetupCompleteResponse'
        '400':
          description: Setup expired or verification failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/mfa/totp/setup:
    post:
      summary: Initiate TOTP Setup
      description: Start TOTP (Time-based One-Time Password) setup process
      tags:
        - MFA Setup
      security:
        - bearerAuth: []
      responses:
        '200':
          description: TOTP setup initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TOTPSetupResponse'
        '401':
          description: Unauthorized - invalid access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/mfa/totp/setup/complete:
    post:
      summary: Complete TOTP Setup
      description: Complete TOTP setup by verifying generated code
      tags:
        - MFA Setup
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - setup_id
                - totp_code
              properties:
                setup_id:
                  type: string
                  format: uuid
                  example: "550e8400-e29b-41d4-a716-446655440019"
                totp_code:
                  type: string
                  pattern: "^[0-9]{6}$"
                  example: "123456"
      responses:
        '200':
          description: TOTP setup completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TOTPSetupCompleteResponse'
        '400':
          description: Invalid TOTP code or setup expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ClientInfo:
      type: object
      required:
        - ip_address
        - user_agent
      properties:
        ip_address:
          type: string
          format: ipv4
          example: "192.168.1.1"
        user_agent:
          type: string
          example: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"

    RegisterResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            user_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440005"
            email:
              type: string
              format: email
              example: "john@example.com"
            alias:
              type: string
              example: "johndoe"
            email_verified:
              type: boolean
              example: false
            status:
              type: string
              enum: [Unverified, Active, Suspended]
              example: "Unverified"
            validation_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440006"
            validation_expires_at:
              type: string
              format: date-time
              example: "2024-06-24T13:00:00Z"
            created_at:
              type: string
              format: date-time
              example: "2024-06-24T12:00:00Z"

    EmailVerificationResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            user_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440005"
            email:
              type: string
              format: email
              example: "john@example.com"
            email_verified:
              type: boolean
              example: true
            status:
              type: string
              enum: [Active, Unverified, Suspended]
              example: "Active"
            verified_at:
              type: string
              format: date-time
              example: "2024-06-24T12:30:00Z"
            session_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440007"
            access_token:
              type: string
              example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            refresh_token:
              type: string
              example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            expires_at:
              type: string
              format: date-time
              example: "2024-06-24T13:30:00Z"

    ResendValidationResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            validation_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440008"
            email:
              type: string
              format: email
              example: "john@example.com"
            attempts:
              type: integer
              example: 2
            max_attempts:
              type: integer
              example: 5
            expires_at:
              type: string
              format: date-time
              example: "2024-06-24T13:00:00Z"
            next_resend_at:
              type: string
              format: date-time
              example: "2024-06-24T12:05:00Z"

    OAuthProvider:
      type: object
      properties:
        provider:
          type: string
          enum: [google, github]
          example: "google"
        display_name:
          type: string
          example: "Google"
        icon_url:
          type: string
          format: uri
          example: "https://cdn.cryptoexchange.com/icons/google.svg"
        is_active:
          type: boolean
          example: true
        supported_scopes:
          type: array
          items:
            type: string
          example: ["email", "profile"]

    OAuthProvidersResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/OAuthProvider'

    WebAuthnSetupPublicKey:
      type: object
      properties:
        challenge:
          type: string
          example: "base64-encoded-challenge"
        rp:
          type: object
          properties:
            name:
              type: string
              example: "CryptoExchange"
            id:
              type: string
              example: "cryptoexchange.com"
        user:
          type: object
          properties:
            id:
              type: string
              example: "base64-user-id"
            name:
              type: string
              example: "john@example.com"
            displayName:
              type: string
              example: "John Doe"
        pubKeyCredParams:
          type: array
          items:
            type: object
            properties:
              alg:
                type: integer
                example: -7
              type:
                type: string
                enum: [public-key]
                example: "public-key"
        timeout:
          type: integer
          example: 60000
        attestation:
          type: string
          enum: [direct, indirect, none]
          example: "direct"
        authenticatorSelection:
          type: object
          properties:
            authenticatorAttachment:
              type: string
              enum: [platform, cross-platform]
              example: "platform"
            userVerification:
              type: string
              enum: [required, preferred, discouraged]
              example: "required"

    WebAuthnSetupResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            challenge_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440015"
            publicKey:
              $ref: '#/components/schemas/WebAuthnSetupPublicKey'
            expires_at:
              type: string
              format: date-time
              example: "2024-06-24T12:05:00Z"

    BiometricSetupResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            challenge_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440017"
            publicKey:
              allOf:
                - $ref: '#/components/schemas/WebAuthnSetupPublicKey'
                - type: object
                  properties:
                    authenticatorSelection:
                      type: object
                      properties:
                        authenticatorAttachment:
                          type: string
                          enum: [platform]
                          example: "platform"
                        userVerification:
                          type: string
                          enum: [required]
                          example: "required"
            expires_at:
              type: string
              format: date-time
              example: "2024-06-24T12:05:00Z"

    WebAuthnSetupCredential:
      type: object
      required:
        - id
        - rawId
        - response
        - type
      properties:
        id:
          type: string
          example: "base64-credential-id"
        rawId:
          type: string
          example: "base64-raw-id"
        response:
          type: object
          properties:
            attestationObject:
              type: string
              example: "base64-attestation-object"
            clientDataJSON:
              type: string
              example: "base64-client-data"
        type:
          type: string
          enum: [public-key]
          example: "public-key"

    BackupCodes:
      type: array
      items:
        type: string
        pattern: "^[A-Z0-9]{6}-[A-Z0-9]{6}$"
      example: ["ABC123-DEF456", "GHI789-JKL012", "MNO345-PQR678"]

    MFASetupCompleteResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            mfa_method_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440016"
            type:
              type: string
              enum: [webauthn]
              example: "webauthn"
            device_name:
              type: string
              example: "YubiKey 5 NFC"
            credential_id:
              type: string
              example: "base64-credential-id"
            created_at:
              type: string
              format: date-time
              example: "2024-06-24T12:00:00Z"
            backup_codes:
              $ref: '#/components/schemas/BackupCodes'

    BiometricSetupCompleteResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            mfa_method_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440018"
            type:
              type: string
              enum: [biometric]
              example: "biometric"
            biometric_type:
              type: string
              enum: [fingerprint, face, voice]
              example: "fingerprint"
            device_info:
              type: object
              properties:
                platform:
                  type: string
                  example: "android"
                device_model:
                  type: string
                  example: "Samsung Galaxy S21"
            created_at:
              type: string
              format: date-time
              example: "2024-06-24T12:00:00Z"
            backup_codes:
              $ref: '#/components/schemas/BackupCodes'

    TOTPSetupResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            setup_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440019"
            secret:
              type: string
              example: "JBSWY3DPEHPK3PXP"
            qr_code:
              type: string
              example: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
            manual_entry_key:
              type: string
              example: "JBSWY3DPEHPK3PXP"
            issuer:
              type: string
              example: "CryptoExchange"
            account_name:
              type: string
              example: "john@example.com"
            expires_at:
              type: string
              format: date-time
              example: "2024-06-24T12:10:00Z"

    TOTPSetupCompleteResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            mfa_method_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440020"
            type:
              type: string
              enum: [totp]
              example: "totp"
            created_at:
              type: string
              format: date-time
              example: "2024-06-24T12:00:00Z"
            backup_codes:
              type: array
              items:
                type: string
                pattern: "^[A-Z0-9]{6}-[A-Z0-9]{6}$"
              example: ["ABC123-DEF456", "GHI789-JKL012", "MNO345-PQR678", "STU901-VWX234", "YZA567-BCD890"]

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "VALIDATION_ERROR"
            message:
              type: string
              example: "Invalid registration parameters"
            details:
              type: object
              additionalProperties: true

tags:
  - name: User Registration
    description: New user account creation endpoints
  - name: Email Validation
    description: Email verification and validation management
  - name: OAuth Providers
    description: OAuth provider information and configuration
  - name: MFA Setup
    description: Multi-factor authentication method setup and configuration